@page "/"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using System.Net.Http.Headers
@using Know.Web.Services
@implements IDisposable

@attribute [Authorize]
@inject HttpClient Http
@inject AuthenticationStateProvider AuthStateProvider
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
@inject NavigationManager Navigation
@inject AppState AppState

<PageTitle>Resources</PageTitle>

<div class="flex flex-col md:flex-row gap-8 items-start">
    <!-- Sidebar Filters (Desktop only) -->
    <aside class="hidden md:block w-64 shrink-0 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl p-4 transition-colors duration-200">
        @FilterContent
    </aside>

    <!-- Main Content -->
    <div class="flex-1 w-full min-w-0">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-[32px] md:text-[40px] font-bold tracking-tight text-slate-900 dark:text-white mb-2 font-['Inter']">Discover Resources</h1>
            <p class="text-lg md:text-xl text-slate-600 dark:text-slate-400 font-['Inter']">Explore shared knowledge from our community</p>
        </div>

        <!-- Search & Filter Bar -->
        <div class="flex flex-row gap-3 mb-4">
            <div class="relative flex-1">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-400">
                        <circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/>
                    </svg>
                </div>
                <input 
                    type="text" 
                    placeholder="Search resource..." 
                    class="block w-full pl-11 pr-4 py-3.5 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl text-slate-900 dark:text-white placeholder-slate-400 focus:ring-2 focus:ring-slate-200 dark:focus:ring-slate-700 focus:border-slate-300 dark:focus:border-slate-600 transition-all text-base"
                    value="@searchQuery"
                    @oninput="OnSearchInput"
                />
            </div>
            <button @onclick="ToggleFilter" class="md:hidden flex items-center justify-center gap-2 px-5 py-3.5 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl text-slate-700 dark:text-slate-300 font-semibold hover:bg-slate-50 dark:hover:bg-slate-700 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="21" y1="4" x2="14" y2="4"/><line x1="10" y1="4" x2="3" y2="4"/><line x1="21" y1="12" x2="12" y2="12"/><line x1="8" y1="12" x2="3" y2="12"/><line x1="21" y1="20" x2="16" y2="20"/><line x1="12" y1="20" x2="3" y2="20"/><line x1="14" y1="2" x2="14" y2="6"/><line x1="8" y1="10" x2="8" y2="14"/><line x1="16" y1="18" x2="16" y2="22"/>
                </svg>
                <span>Filter</span>
            </button>
        </div>

        <!-- Mobile Slide-down Filter -->
        @if (isFilterExpanded)
        {
            <div class="md:hidden mb-8 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl shadow-lg overflow-hidden animate-slide-in-from-top">
                <div class="p-6">
                    <h2 class="text-xl font-bold text-slate-900 dark:text-white mb-6">Filters</h2>
                    @FilterContent
                    
                    <div class="mt-8 pt-6 border-t border-slate-100 dark:border-slate-800 flex gap-3">
                        <button @onclick="ToggleFilter" class="flex-1 px-4 py-3 border border-slate-200 dark:border-slate-700 rounded-xl text-slate-700 dark:text-slate-300 font-semibold hover:bg-slate-50 dark:hover:bg-slate-800 transition-all">
                            Cancel
                        </button>
                        <button @onclick="ToggleFilter" class="flex-1 px-4 py-3 bg-slate-900 dark:bg-blue-600 text-white rounded-xl font-semibold hover:bg-slate-800 dark:hover:bg-blue-700 transition-all">
                            Apply Filters
                        </button>
                    </div>
                </div>
            </div>
        }

        <!-- Loading State & Grid -->
        @if (isLoading)
        {
            <LoadingSpinner Message="Loading resources..." />
        }
        else
        {
            <ResourceGrid 
                Articles="@articles"
                SearchQuery="@searchQuery"
                SelectedCategory="@(selectedCategories.Count > 0 ? string.Join(", ", selectedCategories) : "All")"
                EmptyStateMessage="No resources match your filters."
                OnViewArticle="ViewArticle"
                OnTagClick="HandleTagClick"
            />
            
            @if (hasMoreArticles && articles.Any())
            {
                <div class="mt-8 flex justify-center">
                    <button @onclick="LoadMore" class="px-6 py-2.5 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-300 font-medium rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors shadow-sm">
                        Load More
                    </button>
                </div>
            }
        }
    </div>
</div>

<!-- Resource Modal Component -->
<ResourceModal 
    ShowModal="@showModal"
    IsClosing="@isClosing"
    ModalMode="@modalMode"
    SelectedArticle="@selectedArticle"
    UserId="@userId"
    OnClose="@CloseModal"
    OnArticleCreated="@HandleArticleCreated"
    OnArticleUpdated="@HandleArticleUpdated"
    OnArticleDeleted="@HandleArticleDeleted"
/>

@code {
    private RenderFragment FilterContent => @<text>
        <!-- Resource Type Filter -->
        <div class="mb-6">
            <h3 class="text-[16px] font-normal text-slate-900 dark:text-white mb-3 font-['Inter']">Resource Type</h3>
            <div class="space-y-3">
                <label class="flex items-center gap-2 cursor-pointer group">
                    <input type="checkbox" 
                           checked="@(selectedCategories.Contains("Article"))"
                           @onchange='(e) => ToggleCategory("Article", e.Value)'
                           class="w-3.5 h-3.5 rounded border-gray-300 dark:border-slate-600 text-slate-900 dark:text-white focus:ring-slate-900 dark:focus:ring-slate-400 bg-white dark:bg-slate-800 transition-colors" />
                    <span class="text-[14px] font-medium text-slate-900 dark:text-slate-300 group-hover:text-slate-700 dark:group-hover:text-white font-['Inter']">Article</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer group">
                    <input type="checkbox" 
                           checked="@(selectedCategories.Contains("Code Snippet"))"
                           @onchange='(e) => ToggleCategory("Code Snippet", e.Value)'
                           class="w-3.5 h-3.5 rounded border-gray-300 dark:border-slate-600 text-slate-900 dark:text-white focus:ring-slate-900 dark:focus:ring-slate-400 bg-white dark:bg-slate-800 transition-colors" />
                    <span class="text-[14px] font-medium text-slate-900 dark:text-slate-300 group-hover:text-slate-700 dark:group-hover:text-white font-['Inter']">Code Snippet</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer group">
                    <input type="checkbox" 
                           checked="@(selectedCategories.Contains("Learning Resources"))"
                           @onchange='(e) => ToggleCategory("Learning Resources", e.Value)'
                           class="w-3.5 h-3.5 rounded border-gray-300 dark:border-slate-600 text-slate-900 dark:text-white focus:ring-slate-900 dark:focus:ring-slate-400 bg-white dark:bg-slate-800 transition-colors" />
                    <span class="text-[14px] font-medium text-slate-900 dark:text-slate-300 group-hover:text-slate-700 dark:group-hover:text-white font-['Inter']">Learning Resources</span>
                </label>
            </div>
        </div>

        <!-- Tags Filter -->
        <div>
            <h3 class="text-[16px] font-normal text-slate-900 dark:text-white mb-3 font-['Inter']">Tags</h3>
            <div class="flex flex-wrap gap-2">
                @foreach (var tag in uniqueTags.Take(15))
                {
                    <button @onclick="() => ToggleTag(tag, !selectedTags.Contains(tag))"
                            class="px-2.5 py-1 rounded-full text-[12px] font-medium transition-colors border @(selectedTags.Contains(tag) ? "bg-slate-900 dark:bg-white text-white dark:text-slate-900 border-slate-900 dark:border-white" : "bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 border-slate-200 dark:border-slate-700 hover:border-slate-300 dark:hover:border-slate-600")">
                        @tag
                    </button>
                }
            </div>
        </div>
    </text>;

    private List<Article> articles = new();
    private bool isLoading = true;
    private string searchQuery = "";
    private bool isFilterExpanded = false;
    
    // Filters
    private HashSet<string> selectedCategories = new();
    private HashSet<string> selectedTags = new();
    private List<string> uniqueTags = new();

    private string? userId;
    
    // Modal state
    private bool showModal = false;
    private bool isClosing = false;
    private string modalMode = "view"; // "create" or "view"
    private Article? selectedArticle = null;

    // Pagination
    private int currentPage = 1;
    private const int PageSize = 20;
    private bool hasMoreArticles = true;

    protected override async Task OnInitializedAsync()
    {
        AppState.OnSearchChanged += HandleSearchChanged;
        AppState.OnAddResourceRequested += OpenCreateModal;
        searchQuery = AppState.SearchQuery;

        try
        {
            // Get user ID for creating articles
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            if (user.Identity?.IsAuthenticated == true)
            {
                userId = user.FindFirst("sub")?.Value 
                    ?? user.FindFirst("nameid")?.Value 
                    ?? user.FindFirst("http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier")?.Value;
            }
            
            // Get auth token and set authorization header
            var token = await LocalStorage.GetItemAsync<string>("authToken");
            if (!string.IsNullOrEmpty(token))
            {
                Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);
            }
            
            // Fetch all articles
            await RefreshArticles(reset: true);
            
            // Extract unique tags (initial load only or separate endpoint)
            if (!uniqueTags.Any())
            {
                try 
                {
                    uniqueTags = await Http.GetFromJsonAsync<List<string>>("/api/tags") ?? new();
                }
                catch 
                {
                    // Fallback
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading articles: {ex.Message}");
            articles = new();
        }
        finally
        {
            isLoading = false;
        }
    }

    public void Dispose()
    {
        AppState.OnSearchChanged -= HandleSearchChanged;
        AppState.OnAddResourceRequested -= OpenCreateModal;
    }

    private void ToggleFilter()
    {
        isFilterExpanded = !isFilterExpanded;
        StateHasChanged();
    }

    private void OnSearchInput(ChangeEventArgs e)
    {
        AppState.SetSearchQuery(e.Value?.ToString() ?? "");
    }

    private async void HandleSearchChanged(string query)
    {
        searchQuery = query;
        await RefreshArticles(reset: true);
    }

    private async Task ResetFilters()
    {
        selectedCategories.Clear();
        selectedTags.Clear();
        await RefreshArticles(reset: true);
    }

    private async Task ToggleCategory(string category, object? isChecked)
    {
        if (isChecked is bool check && check)
        {
            selectedCategories.Add(category);
        }
        else
        {
            selectedCategories.Remove(category);
        }
        await RefreshArticles(reset: true);
    }

    private async Task ToggleTag(string tag, object? isChecked)
    {
        if (isChecked is bool check && check)
        {
            selectedTags.Add(tag);
        }
        else
        {
            selectedTags.Remove(tag);
        }
        await RefreshArticles(reset: true);
    }

    private async Task LoadMore()
    {
        currentPage++;
        await RefreshArticles(reset: false);
    }

    private async Task HandleTagClick(string tag)
    {
        selectedTags.Clear();
        selectedTags.Add(tag);
        await RefreshArticles(reset: true);
    }

    private void OpenCreateModal()
    {
        modalMode = "create";
        selectedArticle = null;
        showModal = true;
        isClosing = false;
    }

    private void ViewArticle(int articleId)
    {
        selectedArticle = articles.FirstOrDefault(a => a.Id == articleId);
        if (selectedArticle != null)
        {
            modalMode = "view";
            showModal = true;
            isClosing = false;
        }
    }

    private async Task CloseModal()
    {
        isClosing = true;
        StateHasChanged();
        await Task.Delay(300); // Wait for animation
        showModal = false;
        isClosing = false;
        StateHasChanged();
    }

    private async Task HandleArticleCreated(Article article)
    {
        await RefreshArticles(reset: true);
    }

    private async Task HandleArticleUpdated(Article article)
    {
        selectedArticle = article;
        // Just update the item in the list locally to avoid full reload
        var index = articles.FindIndex(a => a.Id == article.Id);
        if (index != -1)
        {
            articles[index] = article;
            StateHasChanged();
        }
    }

    private async Task HandleArticleDeleted(int articleId)
    {
        if (selectedArticle?.Id == articleId)
        {
            selectedArticle = null;
        }
        articles.RemoveAll(a => a.Id == articleId);
        StateHasChanged();
    }

    private async Task RefreshArticles(bool reset = false)
    {
        try
        {
            if (reset)
            {
                isLoading = true;
                currentPage = 1;
                articles.Clear();
                hasMoreArticles = true;
            }
            
            StateHasChanged();

            var queryParams = new List<string>();
            
            foreach (var category in selectedCategories)
            {
                queryParams.Add($"categories={Uri.EscapeDataString(category)}");
            }

            foreach (var tag in selectedTags)
            {
                queryParams.Add($"tags={Uri.EscapeDataString(tag)}");
            }
            
            if (!string.IsNullOrWhiteSpace(searchQuery))
            {
                queryParams.Add($"search={Uri.EscapeDataString(searchQuery)}");
            }

            queryParams.Add($"page={currentPage}");
            queryParams.Add($"pageSize={PageSize}");

            var queryString = queryParams.Any() ? "?" + string.Join("&", queryParams) : "";
            var apiUrl = $"/api/articles{queryString}";

            var newArticles = await Http.GetFromJsonAsync<List<Article>>(apiUrl) ?? new();
            
            if (newArticles.Count < PageSize)
            {
                hasMoreArticles = false;
            }

            if (reset)
            {
                articles = newArticles;
            }
            else
            {
                articles.AddRange(newArticles);
            }
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error refreshing articles: {ex.Message}");
            if (reset) articles = new();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
}
