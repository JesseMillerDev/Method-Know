@page "/profile"
@using Know.Shared.Models
@using System.Net.Http.Json
@inject HttpClient Http
@inject NavigationManager Navigation
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage

<div class="max-w-3xl mx-auto px-4 md:px-6 py-12 fade-in">
    <div class="flex items-center justify-between mb-12">
        <div>
            <h1 class="text-4xl font-bold text-black dark:text-white tracking-tight mb-2">Your Profile</h1>
            <p class="text-gray-500 dark:text-gray-400">Manage your personal information and preferences.</p>
        </div>
        <div class="hidden md:block h-12 w-12 bg-black dark:bg-white rounded-full opacity-5"></div>
    </div>

    @if (isLoading)
    {
        <div class="flex justify-center items-center h-64">
            <div class="spinner border-black border-t-transparent h-8 w-8"></div>
        </div>
    }
    else if (user is null)
    {
        <div class="p-4 mb-4 text-sm text-red-800 rounded-lg bg-red-50 border border-red-200" role="alert">
            <span class="font-medium">Error!</span> Could not load profile.
        </div>
    }
    else
    {
        <div class="glass-card rounded-2xl p-5 md:p-10 relative overflow-hidden">
            <!-- Decorative background element -->
            <div class="absolute top-0 right-0 -mt-20 -mr-20 w-64 h-64 bg-gradient-to-br from-gray-100 to-gray-200 dark:from-slate-800 dark:to-slate-700 rounded-full blur-3xl opacity-50"></div>

            <div class="flex flex-col md:flex-row items-center gap-8 mb-12 relative z-10">
                <div class="relative group">
                    <div class="h-28 w-28 rounded-full bg-black text-white flex items-center justify-center text-4xl font-bold shadow-2xl ring-4 ring-white transition-transform duration-300 group-hover:scale-105">
                        @GetInitials(user.Email)
                    </div>
                    <div class="absolute bottom-0 right-0 h-8 w-8 bg-green-500 rounded-full border-4 border-white"></div>
                </div>
                <div class="text-center md:text-left">
                    <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-1">@user.Email</h2>
                    <div class="inline-flex items-center px-3 py-1 rounded-full bg-gray-100 dark:bg-slate-800 text-xs font-semibold text-gray-600 dark:text-gray-300 uppercase tracking-wide">
                        Member
                    </div>
                </div>
            </div>

            <EditForm Model="@user" OnValidSubmit="HandleValidSubmit">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="space-y-8 max-w-2xl">
                    <div class="group">
                        <label for="bio" class="block mb-3 text-xs font-bold text-gray-500 dark:text-gray-300 uppercase tracking-widest group-focus-within:text-black dark:group-focus-within:text-white transition-colors">Bio</label>
                        <InputTextArea id="bio" @bind-Value="user.Bio" class="premium-input min-h-[140px] resize-none" placeholder="Tell us a bit about yourself..."></InputTextArea>
                    </div>

                    <div class="group">
                        <label for="interests" class="block mb-3 text-xs font-bold text-gray-500 dark:text-gray-300 uppercase tracking-widest group-focus-within:text-black dark:group-focus-within:text-white transition-colors">Interests</label>
                        <InputText id="interests" @bind-Value="user.Interests" class="premium-input" placeholder="e.g. Coding, Design, AI"></InputText>
                        <p class="mt-2 text-xs text-gray-400">Separate multiple interests with commas.</p>
                    </div>

                    <div class="group">
                        <label for="notifications" class="block mb-3 text-xs font-bold text-gray-500 dark:text-gray-300 uppercase tracking-widest group-focus-within:text-black dark:group-focus-within:text-white transition-colors">Notification Preferences</label>
                        <div class="relative">
                            <InputSelect id="notifications" @bind-Value="user.NotificationPreferences" class="premium-input appearance-none cursor-pointer">
                                <option value="All">All Notifications</option>
                                <option value="ImportantOnly">Important Only</option>
                                <option value="None">None</option>
                            </InputSelect>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-gray-500">
                                <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                            </div>
                        </div>
                    </div>

                    <div class="pt-6 border-t border-gray-100 dark:border-slate-800">
                        <button type="submit" class="premium-button w-full md:w-auto md:px-8">
                            <span>Save Changes</span>
                        </button>
                    </div>
                </div>
            </EditForm>
            
            @if (saveSuccess)
            {
                <div class="mt-6 p-4 text-sm text-green-800 rounded-lg bg-green-50 border border-green-200 flex items-center gap-3 fade-in shadow-sm" role="alert">
                    <div class="h-8 w-8 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 text-green-600">
                            <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm13.36-1.814a.75.75 0 10-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 00-1.06 1.06l2.25 2.25a.75.75 0 001.14-.094l3.75-5.25z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div>
                        <span class="font-bold block">Success!</span>
                        <span class="opacity-90">Your profile has been updated successfully.</span>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private User? user;
    private bool isLoading = true;
    private bool saveSuccess = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var token = await LocalStorage.GetItemAsync<string>("authToken");
            if (!string.IsNullOrEmpty(token))
            {
                Http.DefaultRequestHeaders.Authorization = new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            }

            user = await Http.GetFromJsonAsync<User>("api/profile");
            if (user != null && string.IsNullOrEmpty(user.NotificationPreferences))
            {
                user.NotificationPreferences = "All"; // Default
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading profile: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleValidSubmit()
    {
        if (user is null) return;

        try
        {
            var response = await Http.PutAsJsonAsync("api/profile", user);
            if (response.IsSuccessStatusCode)
            {
                saveSuccess = true;
                // Reset success message after 3 seconds
                _ = Task.Delay(3000).ContinueWith(_ => InvokeAsync(() => { saveSuccess = false; StateHasChanged(); }));
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving profile: {ex.Message}");
        }
    }

    private string GetInitials(string email)
    {
        if (string.IsNullOrEmpty(email)) return "?";
        return email.Substring(0, 1).ToUpper();
    }
}
