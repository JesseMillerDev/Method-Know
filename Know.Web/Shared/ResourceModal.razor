@using Microsoft.AspNetCore.Components.Authorization
@using System.Net.Http.Headers
@using System.Net

@inject HttpClient Http
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
@inject IJSRuntime JSRuntime

<!-- Slide-out Modal -->
@if (ShowModal)
{
    <!-- Backdrop -->
    <div class="modal-backdrop" @onclick="HandleClose"></div>
    
    <!-- Modal Panel -->
    <div class="modal-panel @(IsClosing ? "closing" : "")">
        <!-- Header -->
        <div class="modal-header">
            <h2 class="modal-title">@(ModalMode == "view" ? SelectedArticle?.Title : ModalMode == "edit" ? "Edit Resource" : "Add New Resource")</h2>
            <button @onclick="HandleClose" class="modal-close">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        
        @if (ModalMode != "view")
        {
            <!-- Create Mode: Form -->
            <div class="modal-body">
                <form @onsubmit="HandleSubmit">
                    <!-- Title Field -->
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-black mb-2">
                            Title <span class="text-red-500">*</span>
                        </label>
                        <input 
                            type="text" 
                            @bind="newArticle.Title"
                            placeholder="Enter article title..."
                            class="premium-input"
                            required
                        />
                        @if (showValidation && string.IsNullOrWhiteSpace(newArticle.Title))
                        {
                            <p class="validation-message error">Title is required</p>
                        }
                    </div>
                    
                    <!-- Category Field -->
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-black mb-2">
                            Category <span class="text-red-500">*</span>
                        </label>
                        <select @bind="newArticle.Category" class="premium-select" required>
                            <option value="">Select a category...</option>
                            <option value="Documentation">Documentation</option>
                            <option value="Tutorials">Tutorials</option>
                            <option value="Articles">Articles</option>
                        </select>
                        @if (showValidation && string.IsNullOrWhiteSpace(newArticle.Category))
                        {
                            <p class="validation-message error">Category is required</p>
                        }
                    </div>
                    
                    <!-- Content Field -->
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-black mb-2">
                            Content <span class="text-red-500">*</span>
                        </label>
                        
                        <MarkdownEditor 
                            @bind-Value="newArticle.Content" 
                            Placeholder="Enter your content here... You can use Markdown for formatting."
                        />
                        @if (showValidation && string.IsNullOrWhiteSpace(newArticle.Content))
                        {
                            <p class="validation-message error">Content is required</p>
                        }
                    </div>
                </form>
            </div>
            
            <!-- Footer -->
            <div class="modal-footer">
                <button type="button" @onclick="HandleClose" class="secondary-button" disabled="@isSubmitting">
                    Cancel
                </button>
                <button type="submit" @onclick="HandleSubmit" class="premium-button flex items-center gap-2" disabled="@isSubmitting">
                    @if (isSubmitting)
                    {
                        <div class="spinner"></div>
                        <span>@(ModalMode == "edit" ? "Saving..." : "Creating...")</span>
                    }
                    else
                    {
                        <span>@(ModalMode == "edit" ? "Save Changes" : "Create Resource")</span>
                    }
                </button>
            </div>
        }
        else
        {
            <!-- View Mode: Article Display -->
            <div class="modal-body">
                @if (SelectedArticle != null)
                {
                    <!-- Metadata Bar -->
                    <div class="flex items-center gap-4 mb-6 pb-6 border-b border-gray-200 flex-wrap">
                        <span class="category-badge">
                            @(string.IsNullOrWhiteSpace(SelectedArticle.Category) ? "Uncategorized" : SelectedArticle.Category)
                        </span>
                        <div class="flex items-center gap-2 text-sm text-gray-500">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
                            </svg>
                            <span>@FormatDate(SelectedArticle.CreatedAt)</span>
                        </div>
                        
                        <!-- Tags -->
                        @if (SelectedArticle.TagList != null && SelectedArticle.TagList.Any())
                        {
                            <div class="flex flex-wrap gap-2 ml-auto">
                                @foreach (var tag in SelectedArticle.TagList)
                                {
                                    <span class="px-2.5 py-1 text-xs font-medium text-gray-700 bg-gray-100 rounded-full border border-gray-200">
                                        @tag
                                    </span>
                                }
                            </div>
                        }
                    </div>
                    
                    <!-- Article Content -->
                    <div class="article-content">
                        <MarkdownRenderer Content="@SelectedArticle.Content" />
                    </div>
                }
            </div>
            
            <!-- Footer with Actions -->
            <div class="modal-footer">
                <button type="button" @onclick="HandleClose" class="secondary-button">
                    Close
                </button>
                @if (IsOwner)
                {
                    <div class="flex gap-3">
                        <button type="button" @onclick="BeginEdit" class="secondary-button" disabled="@isSubmitting">
                            Edit
                        </button>
                        <button type="button" @onclick="ConfirmDelete" class="secondary-button text-red-600 border-red-200 hover:border-red-300" disabled="@isSubmitting">
                            Delete
                        </button>
                    </div>
                }
            </div>
        }
    </div>
}

<!-- Toast Notifications -->
@if (showToast)
{
    <div class="toast-notification @toastType">
        <div class="toast-icon">
            @if (toastType == "success")
            {
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            }
            else
            {
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
                </svg>
            }
        </div>
        <div class="toast-message">@toastMessage</div>
    </div>
}

@code {
    [Parameter] public bool ShowModal { get; set; }
    [Parameter] public bool IsClosing { get; set; }
    [Parameter] public string ModalMode { get; set; } = "view"; // "create" or "view"
    [Parameter] public Article? SelectedArticle { get; set; }
    [Parameter] public string? UserId { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback<Article> OnArticleCreated { get; set; }
    [Parameter] public EventCallback<Article> OnArticleUpdated { get; set; }
    [Parameter] public EventCallback<int> OnArticleDeleted { get; set; }
    
    private bool isSubmitting = false;
    private bool showValidation = false;
    private Article newArticle = new();

    private bool IsOwner => SelectedArticle != null && !string.IsNullOrEmpty(UserId) && SelectedArticle.UserId == UserId;
    
    // Toast state
    private bool showToast = false;
    private string toastType = "";
    private string toastMessage = "";

    protected override async Task OnParametersSetAsync()
    {
        if (ShowModal && ModalMode == "create")
        {
            newArticle = new Article();
            showValidation = false;
        }
        else if (ShowModal && ModalMode == "edit" && SelectedArticle != null)
        {
            newArticle = new Article
            {
                Id = SelectedArticle.Id,
                Title = SelectedArticle.Title,
                Content = SelectedArticle.Content,
                Category = SelectedArticle.Category,
                UserId = SelectedArticle.UserId,
                CreatedAt = SelectedArticle.CreatedAt
            };
            showValidation = false;
        }

        // Trigger syntax highlighting when viewing an article
        if (ShowModal && ModalMode == "view" && SelectedArticle != null)
        {
            // Handled by MarkdownRenderer now
        }
    }

    private async Task HandleClose()
    {
        await OnClose.InvokeAsync();
    }

    private async Task HandleSubmit()
    {
        showValidation = true;
        
        // Validate form
        if (string.IsNullOrWhiteSpace(newArticle.Title) || 
            string.IsNullOrWhiteSpace(newArticle.Content) || 
            string.IsNullOrWhiteSpace(newArticle.Category))
        {
            return;
        }
        
        isSubmitting = true;
        StateHasChanged();
        
        try
        {
            if (ModalMode == "edit")
            {
                newArticle.UserId = SelectedArticle?.UserId ?? UserId ?? "";

                var response = await Http.PutAsJsonAsync($"/api/articles/{newArticle.Id}", newArticle);

                if (response.IsSuccessStatusCode)
                {
                    var updatedArticle = await response.Content.ReadFromJsonAsync<Article>();
                    if (updatedArticle != null)
                    {
                        SelectedArticle = updatedArticle;
                        await OnArticleUpdated.InvokeAsync(updatedArticle);
                    }

                    ShowToast("success", "Resource updated successfully!");

                    await Task.Delay(500);
                    ModalMode = "view";
                    await HandleClose();
                }
                else if (response.StatusCode == HttpStatusCode.Forbidden)
                {
                    ShowToast("error", "You can only edit your own resources.");
                }
                else if (response.StatusCode == HttpStatusCode.NotFound)
                {
                    ShowToast("error", "Resource could not be found.");
                }
                else
                {
                    ShowToast("error", "Failed to update resource. Please try again.");
                }
            }
            else
            {
                // Set userId for the new article
                newArticle.UserId = UserId ?? "";
                newArticle.CreatedAt = DateTime.UtcNow;

                // Post to API
                var response = await Http.PostAsJsonAsync("/api/articles", newArticle);

                if (response.IsSuccessStatusCode)
                {
                    var createdArticle = await response.Content.ReadFromJsonAsync<Article>();
                    if (createdArticle != null)
                    {
                        // Notify parent component
                        await OnArticleCreated.InvokeAsync(createdArticle);
                    }

                    // Show success toast
                    ShowToast("success", "Resource created successfully!");

                    // Close modal after a brief delay
                    await Task.Delay(500);
                    await HandleClose();
                }
                else
                {
                    ShowToast("error", "Failed to create resource. Please try again.");
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error creating or updating article: {ex.Message}");
            ShowToast("error", "An error occurred. Please try again.");
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }

    private async void ShowToast(string type, string message)
    {
        toastType = type;
        toastMessage = message;
        showToast = true;
        StateHasChanged();

        await Task.Delay(3000);
        showToast = false;
        StateHasChanged();
    }

    private void BeginEdit()
    {
        if (SelectedArticle == null)
            return;

        newArticle = new Article
        {
            Id = SelectedArticle.Id,
            Title = SelectedArticle.Title,
            Content = SelectedArticle.Content,
            Category = SelectedArticle.Category,
            UserId = SelectedArticle.UserId,
            CreatedAt = SelectedArticle.CreatedAt
        };

        showValidation = false;
        ModalMode = "edit";
        StateHasChanged();
    }

    private async Task ConfirmDelete()
    {
        if (SelectedArticle == null)
            return;

        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this resource?");
        if (!confirmed)
            return;

        isSubmitting = true;
        StateHasChanged();

        try
        {
            var response = await Http.DeleteAsync($"/api/articles/{SelectedArticle.Id}");

            if (response.IsSuccessStatusCode)
            {
                await OnArticleDeleted.InvokeAsync(SelectedArticle.Id);
                ShowToast("success", "Resource deleted successfully.");

                await Task.Delay(400);
                await HandleClose();
            }
            else if (response.StatusCode == HttpStatusCode.Forbidden)
            {
                ShowToast("error", "You can only delete your own resources.");
            }
            else if (response.StatusCode == HttpStatusCode.NotFound)
            {
                ShowToast("error", "Resource could not be found.");
            }
            else
            {
                ShowToast("error", "Failed to delete resource. Please try again.");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting article: {ex.Message}");
            ShowToast("error", "An error occurred while deleting the resource.");
        }
        finally
        {
            isSubmitting = false;
            StateHasChanged();
        }
    }

    private string FormatDate(DateTime date)
    {
        var timeSpan = DateTime.UtcNow - date;
        
        if (timeSpan.TotalDays < 1)
            return "Today";
        else if (timeSpan.TotalDays < 2)
            return "Yesterday";
        else if (timeSpan.TotalDays < 7)
            return $"{(int)timeSpan.TotalDays} days ago";
        else if (timeSpan.TotalDays < 30)
            return $"{(int)(timeSpan.TotalDays / 7)} weeks ago";
        else
            return date.ToString("MMM dd, yyyy");
    }
    



}
