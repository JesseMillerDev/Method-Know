@inherits LayoutComponentBase
@inject Know.Web.Services.AppState AppState
@inject Know.Web.Services.ThemeService ThemeService
@implements IDisposable

<div class="min-h-screen bg-[#fcfcfc] dark:bg-slate-950 flex flex-col font-sans transition-colors duration-200">
    <!-- Top Navigation Header -->
    <header class="bg-white dark:bg-slate-900 border-b border-gray-100 dark:border-slate-800 sticky top-0 z-50 transition-colors duration-200">
        <div class="max-w-[1440px] mx-auto px-4 sm:px-6 lg:px-12 h-[80px] flex items-center justify-between gap-8">
            <!-- Logo Section -->
            <div class="flex items-center gap-3 shrink-0">
                <div class="w-12 h-12 bg-slate-900 dark:bg-white rounded-full flex items-center justify-center shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-white dark:text-slate-900">
                        <path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/>
                        <path d="M8 7h8"/>
                        <path d="M8 11h8"/>
                        <path d="M8 15h8"/>
                    </svg>
                </div>
                <span class="text-[22px] font-bold tracking-tight text-slate-900 dark:text-white font-['Inter']">Method Know</span>
            </div>

            <!-- Right Actions -->
            <div class="flex items-center gap-4 shrink-0">
                <AuthorizeView>
                    <Authorized>
                        <button @onclick="HandleAddResource" class="hidden sm:flex items-center gap-2 px-5 py-2.5 bg-slate-900 dark:bg-white text-white dark:text-slate-900 text-[14px] font-semibold rounded-lg hover:bg-slate-800 dark:hover:bg-slate-100 transition-all shadow-sm">
                            <span>Share Resource</span>
                        </button>

                        <!-- Notifications -->
                        <button class="p-2 text-slate-400 hover:text-slate-900 dark:hover:text-white transition-colors relative">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/>
                            </svg>
                            <span class="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full border-2 border-white"></span>
                        </button>

                        <!-- Profile Dropdown -->
                        <div class="relative" @onclick="ToggleDropdown">
                            <button class="flex items-center gap-3 pl-2 pr-1 py-1 rounded-full hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                                <div class="w-10 h-10 rounded-full bg-slate-900 dark:bg-white text-white dark:text-slate-900 flex items-center justify-center font-medium text-sm">
                                    JM
                                </div>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-400">
                                    <path d="m6 9 6 6 6-6"/>
                                </svg>
                            </button>

                            @if (showDropdown)
                            {
                                <div class="absolute right-0 mt-2 w-56 rounded-xl shadow-lg bg-white dark:bg-slate-900 border border-slate-100 dark:border-slate-800 py-2 z-50 animate-in fade-in slide-in-from-top-2 duration-200">
                                    <div class="px-4 py-3 border-b border-slate-50 dark:border-slate-800">
                                        <p class="text-sm font-semibold text-slate-900 dark:text-white">Jesse Miller</p>
                                        <p class="text-xs text-slate-500">jesse@example.com</p>
                                    </div>
                                    <div class="py-1">
                                        <a href="profile" class="flex items-center gap-2 px-4 py-2 text-sm text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                                            Profile
                                        </a>
                                        <button @onclick="ToggleTheme" class="w-full flex items-center gap-2 px-4 py-2 text-sm text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                                            @if (ThemeService.IsDarkMode)
                                            {
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
                                                <span>Light Mode</span>
                                            }
                                            else
                                            {
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
                                                <span>Dark Mode</span>
                                            }
                                        </button>
                                        <button @onclick="Logout" class="w-full flex items-center gap-2 px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
                                            Log out
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>
                    </Authorized>
                    <NotAuthorized>
                        <div class="flex items-center gap-4">
                            <a href="login" class="text-sm font-semibold text-slate-900 dark:text-white hover:text-slate-700 dark:hover:text-slate-300">Log in</a>
                            <a href="signup" class="px-4 py-2.5 text-sm font-semibold bg-slate-900 dark:bg-white text-white dark:text-slate-900 rounded-lg hover:bg-slate-800 dark:hover:bg-slate-100 transition-all shadow-sm hover:shadow">Sign up</a>
                        </div>
                    </NotAuthorized>
                </AuthorizeView>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 w-full max-w-[1440px] mx-auto px-4 sm:px-6 lg:px-12 py-8">
        @Body
    </main>
</div>

@code {
    [Inject] AuthenticationStateProvider AuthStateProvider { get; set; } = default!;
    [Inject] NavigationManager Navigation { get; set; } = default!;
    [Inject] Blazored.LocalStorage.ILocalStorageService LocalStorage { get; set; } = default!;

    private bool showDropdown = false;

    protected override async Task OnInitializedAsync()
    {
        ThemeService.OnChange += StateHasChanged;
        await ThemeService.InitializeAsync();
    }

    public void Dispose()
    {
        ThemeService.OnChange -= StateHasChanged;
    }

    private void ToggleDropdown()
    {
        showDropdown = !showDropdown;
    }

    private void HandleAddResource()
    {
        AppState.RequestAddResource();
    }

    private void OnSearchInput(ChangeEventArgs e)
    {
        AppState.SetSearchQuery(e.Value?.ToString() ?? "");
    }

    private async Task Logout()
    {
        showDropdown = false;
        await LocalStorage.RemoveItemAsync("authToken");
        ((Know.Web.Auth.CustomAuthStateProvider)AuthStateProvider).MarkUserAsLoggedOut();
        Navigation.NavigateTo("/");
    }
    private async Task ToggleTheme()
    {
        await ThemeService.ToggleThemeAsync();
    }
}
